<!DOCTYPE html>
<html lang="en">
<head>
	<title>Service Example | Cel</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" >
	<script
		src="https://code.jquery.com/jquery-3.1.1.min.js"
		integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
		crossorigin="anonymous"></script>
</head>
<body>


<!-- Style -->
<style>
	.widget {
		text-align: center;
		cursor: pointer;
	}
</style>


<!-- Markup -->
<section class="widget">
	<h1 class="widget__header">Service Example</h1>
	<button class="widget__button">Get Users</button>
	<pre class="widget__list"></pre>
</section>



<!-- Scripting -->
<script src="../dist/cel.js"></script>
<script>
var APP = window.APP || {};
APP.controllers = {};
APP.services = {};

// app/controllers/widget.js
APP.controllers.widget = Cel({
	name: 'Widget',
	state: {
		users: []
	},
	elems: [
		{ name: 'button', selector: '.widget__button' },
		{ name: 'list', selector: '.widget__list' }
	],
	methods: {
		fetchData: function() {
			this.setState( 'users', APP.services.users.getUsers() );
			this.methods.updateUIList()
		},
		updateUIList: function() {
			this.setHtml('list', this.state.users)
		}
	},
	handlers: {
		buttonClick: function(e) {
			this.methods.fetchData();
		}
	},
	events: [
		{
			target: 'button',
			type: 'click',
			handler: 'buttonClick'
		}
	]
});

// app/services/users.js
APP.services.users = Cel({
	name: 'UserService',
	_: {
		GH_USERS_API_ENDPOINT: 'https://api.github.com/users'
	},
	state: {
		users: []
	},
	methods: {
		ajaxCall: function(url, callback) {
			var xmlhttp;
			xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
				if (
					xmlhttp.readyState == 4 &&
					xmlhttp.status == 200
				) {
					callback(xmlhttp.responseText);
				}
			}
			xmlhttp.open("GET", url, true);
			xmlhttp.send();
		},
		fetchGithubUsers: function() {
			this.methods.ajaxCall(
				this._.GH_USERS_API_ENDPOINT,
				this.methods.setUsers
			);
		},
		setUsers: function( newUsers ) {
			this.setState( 'users', newUsers );
		},
		getUsers: function() {
			if ( this.state.users.length < 1 ) {
				this.methods.fetchGithubUsers();
			} else {
				return this.state.users;
			}
		}
	},
	exposed: [ 'getUsers' ]
});

APP.controllers.widget.init();
APP.services.users.init();
</script>

</body>
</html>